const express = require('express');
const cors = require('cors');
const app = express();
const PORT = 3000;

// ä¸­é—´ä»¶
app.use(cors());
app.use(express.json());

// æ¨¡æ‹Ÿ AI ç”Ÿæˆæ¥å£ - æµå¼ç‰ˆæœ¬
app.post('/generate/stream', (req, res) => {
  console.log('æ”¶åˆ°æµå¼ç”Ÿæˆè¯·æ±‚:', req.body);
  
  // è®¾ç½®æµå¼å“åº”å¤´
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive'
    // åˆ é™¤äº† 'Access-Control-Allow-Origin': '*'ï¼Œç”±é¡¶éƒ¨çš„ app.use(cors()) ç»Ÿä¸€æ¥ç®¡
  });

  // æ¨¡æ‹Ÿæµå¼æ•°æ®å‘é€
  const mockData = [
    { type: 'title', value: 'ç¬¬ä¸€ç«  ç¥ç§˜çš„é‚€è¯·å‡½' },
    { type: 'content', value: 'å¤œè‰²å¦‚å¢¨ï¼Œé›¨ä¸æ–œç»‡ã€‚æ—é»˜ç«™åœ¨è€æ—§å…¬å¯“çš„çª—å‰ï¼Œæ‰‹ä¸­æ¡ç€ä¸€å°æ³›é»„çš„ä¿¡å°ã€‚' },
    { type: 'content', value: 'ä¿¡å°ä¸Šæ²¡æœ‰å¯„ä»¶äººå§“åï¼Œåªæœ‰ä¸€è¡Œå¨Ÿç§€çš„å°å­—ï¼š"è‡´å‘½è¿çš„ç¼–ç»‡è€…"ã€‚' },
    { type: 'content', value: 'ä»–è½»è½»æ‹†å¼€ä¿¡å°ï¼Œä¸€å¼ ç¾Šçš®çº¸æ»‘è½è€Œå‡ºã€‚çº¸å¼ è¾¹ç¼˜å·²ç»ç£¨æŸï¼Œä¸Šé¢ç”¨æš—çº¢è‰²å¢¨æ°´å†™ç€ä¸€æ®µè¯ï¼š' },
    { type: 'content', value: '"å½“æœˆå…‰ä¸å½±å­é‡å ä¹‹æ—¶ï¼Œå¤è€çš„å›¾ä¹¦é¦†å°†å‘ä½ æ•å¼€å¤§é—¨ã€‚é‚£é‡Œè—ç€æ”¹å˜ä¸€åˆ‡çš„ç§˜å¯†ï¼Œä½†è®°ä½â€”â€”é€‰æ‹©å³ä»£ä»·ã€‚"' },
    { type: 'branches', value: JSON.stringify([
      'è·Ÿéšç¥ç§˜äººå½±çš„æŒ‡å¼•ï¼Œå‰å¾€å¯¹é¢å¤§æ¥¼',
      'ä»”ç»†ç ”ç©¶ä¿¡ä»¶ï¼Œå¯»æ‰¾éšè—çš„çº¿ç´¢',
      'è”ç³»è€æœ‹å‹ï¼Œè¯¢é—®å…³äºçˆ¶äº²å¤±è¸ªçš„å¾€äº‹'
    ]) }
  ];

  // æ¨¡æ‹Ÿé€æ­¥å‘é€æ•°æ®
  let index = 0;
  const sendNext = () => {
    if (index < mockData.length) {
      const data = mockData[index];
      const sseData = `data: ${JSON.stringify(data)}\n\n`;
      res.write(sseData);
      index++;
      
      // é—´éš”å‘é€ï¼Œæ¨¡æ‹ŸçœŸå®æµå¼æ•ˆæœ
      setTimeout(sendNext, index === 1 ? 1000 : 800);
    } else {
      // å‘é€å®Œæˆä¿¡å·
      res.write(`data: {"type":"complete","value":"ç”Ÿæˆå®Œæˆ"}\n\n`);
      res.end();
    }
  };

  sendNext();
});

// æ™®é€šç”Ÿæˆæ¥å£ï¼ˆéæµå¼ï¼‰
app.post('/generate', (req, res) => {
  console.log('æ”¶åˆ°æ™®é€šç”Ÿæˆè¯·æ±‚:', req.body);
  
  // æ¨¡æ‹Ÿ AI ç”Ÿæˆç»“æœ
  setTimeout(() => {
    res.json({
      title: 'ç¬¬ä¸€ç«  ç¥ç§˜çš„é‚€è¯·å‡½',
      content: `å¤œè‰²å¦‚å¢¨ï¼Œé›¨ä¸æ–œç»‡ã€‚æ—é»˜ç«™åœ¨è€æ—§å…¬å¯“çš„çª—å‰ï¼Œæ‰‹ä¸­æ¡ç€ä¸€å°æ³›é»„çš„ä¿¡å°ã€‚ä¿¡å°ä¸Šæ²¡æœ‰å¯„ä»¶äººå§“åï¼Œåªæœ‰ä¸€è¡Œå¨Ÿç§€çš„å°å­—ï¼š"è‡´å‘½è¿çš„ç¼–ç»‡è€…"ã€‚

ä»–è½»è½»æ‹†å¼€ä¿¡å°ï¼Œä¸€å¼ ç¾Šçš®çº¸æ»‘è½è€Œå‡ºã€‚çº¸å¼ è¾¹ç¼˜å·²ç»ç£¨æŸï¼Œä¸Šé¢ç”¨æš—çº¢è‰²å¢¨æ°´å†™ç€ä¸€æ®µè¯ï¼š

"å½“æœˆå…‰ä¸å½±å­é‡å ä¹‹æ—¶ï¼Œå¤è€çš„å›¾ä¹¦é¦†å°†å‘ä½ æ•å¼€å¤§é—¨ã€‚é‚£é‡Œè—ç€æ”¹å˜ä¸€åˆ‡çš„ç§˜å¯†ï¼Œä½†è®°ä½â€”â€”é€‰æ‹©å³ä»£ä»·ã€‚"

æ—é»˜çš„å¿ƒè·³çªç„¶åŠ å¿«ã€‚è¿™å°ä¿¡ï¼Œå’Œä¸‰å¹´å‰çˆ¶äº²å¤±è¸ªå‰ç•™ä¸‹çš„æœ€åä¸€å¥è¯ä¸€æ¨¡ä¸€æ ·ã€‚

çª—å¤–ï¼Œä¸€é“é—ªç”µåˆ’ç ´å¤œç©ºï¼Œç…§äº®äº†å¯¹é¢å¤§æ¥¼ç»ç’ƒå¹•å¢™ä¸Šçš„å€’å½±â€”â€”é‚£é‡Œï¼Œä¼¼ä¹æœ‰ä¸€ä¸ªæ¨¡ç³Šçš„äººå½±æ­£æ³¨è§†ç€ä»–ã€‚`,
      branches: [
        'è·Ÿéšç¥ç§˜äººå½±çš„æŒ‡å¼•ï¼Œå‰å¾€å¯¹é¢å¤§æ¥¼',
        'ä»”ç»†ç ”ç©¶ä¿¡ä»¶ï¼Œå¯»æ‰¾éšè—çš„çº¿ç´¢',
        'è”ç³»è€æœ‹å‹ï¼Œè¯¢é—®å…³äºçˆ¶äº²å¤±è¸ªçš„å¾€äº‹'
      ]
    });
  }, 2000);
});

// æ¶¦è‰²æ¥å£
app.post('/polish', (req, res) => {
  console.log('æ”¶åˆ°æ¶¦è‰²è¯·æ±‚:', req.body);
  
  const { text } = req.body;
  if (!text) {
    return res.status(400).json({ error: 'ç¼ºå°‘æ–‡æœ¬å†…å®¹' });
  }

  // ç®€å•çš„æ–‡æœ¬æ¶¦è‰²æ¨¡æ‹Ÿ
  setTimeout(() => {
    const polishedText = text.replace(/([ã€‚ï¼ï¼Ÿ])/g, '$1 ').trim();
    res.json({ text: polishedText });
  }, 1000);
});

// å¥åº·æ£€æŸ¥æ¥å£
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log(`ğŸš€ AIBook åç«¯æœåŠ¡å·²å¯åŠ¨`);
  console.log(`ğŸ“¡ ç›‘å¬ç«¯å£: ${PORT}`);
  console.log(`ğŸ“ æµå¼æ¥å£: http://localhost:${PORT}/generate/stream`);
  console.log(`ğŸ“ æ™®é€šæ¥å£: http://localhost:${PORT}/generate`);
  console.log(`ğŸ“ æ¶¦è‰²æ¥å£: http://localhost:${PORT}/polish`);
  console.log(`ğŸ’š å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);
});